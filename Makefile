.PHONY: help init infra backend frontend clean

# ==============================================================================
# ğŸ¯ é»˜è®¤ç›®æ ‡ï¼šæ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
# ==============================================================================
help:
	@echo ""
	@echo "âœ¨ Note App å¼€å‘ç®¡ç†å·¥å…· âœ¨"
	@echo ""
	@echo "ä½¿ç”¨æ–¹æ³•: make [ç›®æ ‡]"
	@echo ""
	@echo "ğŸš€ å¿«é€Ÿå¼€å§‹:"
	@echo "  make init       - åˆå§‹åŒ–ç¯å¢ƒ (ç”Ÿæˆ .env, ä¸‹è½½å‰åç«¯ä¾èµ–)"
	@echo "  make infra      - å¯åŠ¨ Docker åŸºç¡€è®¾æ–½ (MySQL, Redis, Qdrant...)"
	@echo "  make backend    - å¯åŠ¨ Go åç«¯æœåŠ¡ (localhost:8080)"
	@echo "  make frontend   - å¯åŠ¨ React å‰ç«¯æœåŠ¡ (localhost:5173)"
	@echo ""
	@echo "ğŸ›   ç»´æŠ¤å‘½ä»¤:"
	@echo "  make clean      - åœæ­¢å¹¶ç§»é™¤æ‰€æœ‰ Docker å®¹å™¨"
	@echo ""

# ==============================================================================
# ğŸ›  åˆå§‹åŒ– (Initialization)
# ==============================================================================
init:
	@echo "æ­£åœ¨æ£€æŸ¥é…ç½®æ–‡ä»¶..."
	@if [ ! -f .env ]; then \
		if [ -f .env.example ]; then \
			cp .env.example .env; \
			echo "âœ… å·²ä»æ¨¡æ¿ç”Ÿæˆ .env æ–‡ä»¶ï¼Œè¯·è®°å¾—å¡«å†™ Keyï¼"; \
		else \
			echo "âš ï¸ æœªæ‰¾åˆ° .env.example æ¨¡æ¿ï¼Œè·³è¿‡é…ç½®ç”Ÿæˆã€‚"; \
		fi \
	else \
		echo "â„¹ï¸ .env æ–‡ä»¶å·²å­˜åœ¨ï¼Œè·³è¿‡ã€‚"; \
	fi

	@echo "\næ­£åœ¨ä¸‹è½½ Go ä¾èµ–..."
	go mod tidy

	@echo "\næ­£åœ¨å®‰è£…å‰ç«¯ä¾èµ–..."
	cd web && npm install

	@echo "\nâœ… åˆå§‹åŒ–å®Œæˆï¼è¯·è¿è¡Œ 'make infra' å¯åŠ¨æ•°æ®åº“ã€‚"

# ==============================================================================
# ğŸ³ åŸºç¡€è®¾æ–½ (Infrastructure)
# ==============================================================================
infra:
	@echo "æ­£åœ¨å¯åŠ¨åŸºç¡€æœåŠ¡ (MySQL, Redis, RabbitMQ, MinIO, Qdrant, Jaeger)..."
	# æ˜¾å¼æŒ‡å®šæœåŠ¡åï¼Œé¿å…å¯åŠ¨ app å®¹å™¨å¯¼è‡´ç«¯å£å†²çª
	docker-compose up -d mysql redis rabbitmq minio qdrant jaeger
	@echo "âœ… åŸºç¡€è®¾æ–½å¯åŠ¨æˆåŠŸï¼"

# ==============================================================================
# ğŸ–¥ åç«¯ (Backend)
# ==============================================================================
backend:
	@echo "æ­£åœ¨å¯åŠ¨ Go åç«¯..."
	# ç¡®ä¿ backend ä¾èµ–çš„åŸºç¡€è®¾æ–½å·²ç»å¯åŠ¨
	go run cmd/main.go

# ==============================================================================
# ğŸ¨ å‰ç«¯ (Frontend)
# ==============================================================================
frontend:
	@echo "æ­£åœ¨å¯åŠ¨ React å‰ç«¯..."
	cd web && npm run dev

# ==============================================================================
# ğŸ§¹ æ¸…ç† (Cleaning)
# ==============================================================================
clean:
	@echo "æ­£åœ¨åœæ­¢æ‰€æœ‰æœåŠ¡..."
	docker-compose down
	@echo "âœ… ç¯å¢ƒå·²æ¸…ç†"